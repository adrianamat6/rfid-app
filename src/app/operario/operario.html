<div class="terminal-layout" (click)="mantenerFoco()">

  <!-- TOPBAR â€” igual que trazabilidad -->
  <header class="topbar">
    <h1>Modo Escaneo</h1>
    <div class="topbar-right">
      <button class="btn-ghost danger" (click)="limpiarHistorial()">ğŸ—‘ Borrar historial</button>
      <button class="btn-ghost" (click)="volver()">â† ConfiguraciÃ³n</button>
    </div>
  </header>

  <div class="content">

    <!-- STATS ROW â€” igual que trazabilidad -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon" style="background:#ede9fe;">ğŸ“¡</div>
        <div>
          <div class="stat-label">Total escaneados</div>
          <div class="stat-value">{{ escaneos.length }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#d1fae5;">âœ“</div>
        <div>
          <div class="stat-label">Puesto activo</div>
          <div class="stat-value stat-sm">{{ puntoSeleccionado?.nombre || 'â€”' }}</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#fef3c7;">ğŸ•</div>
        <div>
          <div class="stat-label">Ãšltimo escaneo</div>
          <div class="stat-value stat-sm">
            {{ escaneos.length > 0 ? formatHora(escaneos[0].timestamp) : 'â€”' }}
          </div>
        </div>
      </div>
    </div>

    <!-- SELECTOR DE PUESTO -->
    <div class="card">
      <div class="card-title">Seleccionar puesto</div>
      <div class="puntos-grid" *ngIf="puntosLinea.length > 0">
        <button
          class="punto-btn"
          *ngFor="let p of puntosLinea"
          [class.active]="p.id === puntoSeleccionado?.id"
          (click)="seleccionarPunto(p)"
        >
          <span class="punto-idx">P-{{ (p.id + 1).toString().padStart(2,'0') }}</span>
          <span class="punto-nombre">{{ p.nombre }}</span>
        </button>
      </div>
      <div class="no-linea" *ngIf="puntosLinea.length === 0">
        âš  No hay ninguna lÃ­nea configurada.
        <strong (click)="volver()" style="cursor:pointer; text-decoration:underline;">
          Ve a ConfiguraciÃ³n
        </strong>
        y guarda una lÃ­nea primero.
      </div>
    </div>

    <!-- ZONA DE ESCANEO -->
    <div class="card scan-card" [class.ready]="!!puntoSeleccionado">
      <div class="card-title">Zona de escaneo</div>
      <div class="scan-zone">
        <div class="scan-icon-big">{{ puntoSeleccionado ? 'ğŸ“¡' : 'âš ' }}</div>
        <div class="scan-hint">
          {{ puntoSeleccionado
            ? 'Lector activo â€” apunta y dispara el gatillo'
            : 'Selecciona un puesto arriba para activar el lector' }}
        </div>
        <div class="scan-status" *ngIf="puntoSeleccionado">
          <div class="dot-pulse"></div>
          LECTOR ACTIVO Â· {{ puntoSeleccionado.nombre }}
        </div>
        <input
          #scanInput
          class="pda-hidden-input"
          type="text"
          [(ngModel)]="inputScan"
          (ngModelChange)="onInputChange($event)"
          (keydown.enter)="procesarDato(inputScan)"
          [disabled]="!puntoSeleccionado"
          autocomplete="off"
        />
      </div>
    </div>

    <!-- HISTORIAL -->
    <div class="card" *ngIf="escaneos.length > 0">
      <div class="pipeline-header">
        <div class="card-title" style="margin:0">Historial de escaneos</div>
        <div class="badge">
          <div class="badge-dot"></div>
          <span>{{ escaneos.length }} registro{{ escaneos.length !== 1 ? 's' : '' }}</span>
        </div>
      </div>
      <div class="historial">
        <div
          class="historial-item"
          *ngFor="let e of escaneos; let i = index"
          [class.first]="i === 0"
        >
          <div class="historial-icon">ğŸ·</div>
          <div class="historial-body">
            <div class="historial-chip">{{ e.chipId }}</div>
            <div class="historial-meta">{{ e.puntoNombre }} Â· {{ formatHora(e.timestamp) }}</div>
          </div>
          <div class="historial-ok">OK</div>
        </div>
      </div>
    </div>

    <!-- EMPTY -->
    <div class="empty-state" *ngIf="escaneos.length === 0 && puntoSeleccionado">
      <div class="empty-icon">ğŸ“­</div>
      <p>Sin escaneos todavÃ­a</p>
      <span>Dispara el gatillo para registrar el primer chip</span>
    </div>

  </div>
</div>