<div class="inv-root">

  <!-- TOPBAR -->
  <header class="inv-topbar">
    <div class="inv-topbar-left">
      <button class="btn-back" (click)="volver()">‚Üê</button>
      <div class="inv-title-block">
        <span class="inv-label">INVENTARIO</span>
        <h1 class="inv-title">{{ lineaActiva?.name || 'Sin l√≠nea' }}</h1>
      </div>
    </div>
    <div class="inv-topbar-right">
      <span class="inv-route-pill">
        <span *ngFor="let p of puntos; let last = last">
          {{ p }}<span *ngIf="!last" class="route-sep"> ‚Üí </span>
        </span>
      </span>
    </div>
  </header>

  <div class="inv-body">

    <!-- ‚ïê‚ïê PASO 1: CAT√ÅLOGO ‚ïê‚ïê -->
    <section class="inv-section">
      <div class="section-head">
        <div class="step-badge">01</div>
        <div>
          <div class="section-title">Cat√°logo Maestro</div>
          <div class="section-sub">Archivo CSV con columnas: EPC prefijo, Nombre modelo</div>
        </div>
        <div class="section-status" [class.done]="catalogo.length > 0">
          {{ catalogo.length > 0 ? '‚úì ' + catalogo.length + ' modelos cargados' : 'Pendiente' }}
        </div>
      </div>
      <div class="upload-row">
        <label class="upload-btn" [class.loaded]="catalogo.length > 0">
          <input type="file" accept=".csv,.txt" (change)="onCatalogoSelected($event)" hidden>
          <span class="upload-icon">{{ catalogo.length > 0 ? 'üìó' : 'üìÇ' }}</span>
          <span>{{ catalogoNombre || 'Seleccionar cat√°logo maestro' }}</span>
        </label>
      </div>
    </section>

    <!-- ‚ïê‚ïê PASO 2: CSVs POR PUNTO ‚ïê‚ïê -->
    <section class="inv-section">
      <div class="section-head">
        <div class="step-badge">02</div>
        <div>
          <div class="section-title">Lecturas por Punto</div>
          <div class="section-sub">Sube el CSV de cada punto de control</div>
        </div>
        <div class="section-status" [class.done]="todosCSVCargados">
          {{ puntosConCSV }}/{{ puntos.length }} puntos cargados
        </div>
      </div>

      <div class="puntos-upload-grid">
        <div class="punto-upload-card" *ngFor="let p of puntos; let i = index"
             [class.loaded]="(epcsPorPunto[p]?.length ?? 0) > 0">
          <div class="punto-upload-header">
            <span class="punto-idx-badge">P-{{ (i+1).toString().padStart(2,'0') }}</span>
            <span class="punto-upload-name">{{ p }}</span>
            <span class="punto-count" *ngIf="(epcsPorPunto[p]?.length ?? 0) > 0">
              {{ epcsPorPunto[p].length }} EPCs
            </span>
          </div>
          <label class="punto-upload-btn">
            <input type="file" accept=".csv,.txt" (change)="onCSVPuntoSelected($event, p)" hidden>
            <span>{{ csvNombres[p] || '+ Subir CSV de ' + p }}</span>
          </label>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê PASO 3: GENERAR ‚ïê‚ïê -->
    <section class="inv-section inv-action-section" *ngIf="catalogo.length > 0 && puntosConCSV > 0">
      <button class="btn-generar" (click)="generarTabla()">
        <span>‚ö°</span>
        GENERAR COMPARATIVA
      </button>
      <span class="action-hint" *ngIf="!todosCSVCargados">
        Faltan {{ puntos.length - puntosConCSV }} punto(s) por cargar ‚Äî puedes generar igualmente
      </span>
    </section>

    <!-- ‚ïê‚ïê TABLA COMPARATIVA ‚ïê‚ïê -->
    <section class="inv-section tabla-section" *ngIf="tablaGenerada">

      <!-- Resumen stats -->
      <div class="stats-bar">
        <div class="stat-chip total">
          <span class="stat-n">{{ totalArticulos }}</span>
          <span class="stat-lbl">Art√≠culos</span>
        </div>
        <div class="stat-chip ok">
          <span class="stat-n">{{ articulosCompletos }}</span>
          <span class="stat-lbl">Completos</span>
        </div>
        <div class="stat-chip warn">
          <span class="stat-n">{{ articulosConPerdida }}</span>
          <span class="stat-lbl">Con p√©rdida</span>
        </div>
      </div>

      <!-- Filtro -->
      <div class="tabla-toolbar">
        <input class="filtro-input" type="text" placeholder="üîç  Buscar modelo o EPC..."
               [(ngModel)]="filtroTexto">
        <span class="filtro-count">{{ filasFiltradas.length }} resultados</span>
      </div>

      <!-- Tabla -->
      <div class="tabla-scroll">
        <table class="comp-table">
          <thead>
            <tr>
              <th class="th-modelo">MODELO</th>
              <th class="th-epc">EPC</th>
              <th class="th-punto" *ngFor="let p of puntos">{{ p }}</th>
              <th class="th-prog">PROGRESO</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fila of filasFiltradas"
                [class.row-completa]="presenciaTotal(fila) === puntos.length"
                [class.row-perdida]="presenciaTotal(fila) < puntos.length">
              <td class="td-modelo">
                <span class="modelo-tag">{{ fila.modelo }}</span>
              </td>
              <td class="td-epc">
                <code>{{ fila.epc }}</code>
              </td>
              <td class="td-check" *ngFor="let p of puntos">
                <span class="check-icon" [class.present]="fila.presencia[p]" [class.absent]="!fila.presencia[p]">
                  {{ fila.presencia[p] ? '‚úì' : '‚úó' }}
                </span>
              </td>
              <td class="td-prog">
                <div class="mini-bar">
                  <div class="mini-fill"
                       [style.width.%]="(presenciaTotal(fila) / puntos.length) * 100"
                       [class.fill-full]="presenciaTotal(fila) === puntos.length"
                       [class.fill-partial]="presenciaTotal(fila) < puntos.length && presenciaTotal(fila) > 0"
                       [class.fill-none]="presenciaTotal(fila) === 0">
                  </div>
                </div>
                <span class="mini-label">{{ presenciaTotal(fila) }}/{{ puntos.length }}</span>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="tabla-empty" *ngIf="filasFiltradas.length === 0">
          <span>Sin resultados para "{{ filtroTexto }}"</span>
        </div>
      </div>
    </section>

    <!-- Estado vac√≠o inicial -->
    <div class="empty-start" *ngIf="!tablaGenerada && catalogo.length === 0">
      <div class="empty-icon-big">üì¶</div>
      <p>Empieza cargando el cat√°logo maestro</p>
      <span>Despu√©s sube los CSVs de cada punto y genera la comparativa</span>
    </div>

  </div>
</div>